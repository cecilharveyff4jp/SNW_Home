  // å…µå£«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹é–¢æ•°
  const startSoldierAnimation = (bearTrap: Obj) => {
    // ã™ã¹ã¦ã®éƒ½å¸‚ã‚’æ¤œç´¢ï¼ˆè¿‘ãã«ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’éƒ½å¸‚ã¨ã¿ãªã™ï¼‰
    const cities = objects.filter(obj => {
      // éƒ½å¸‚åˆ¤å®šï¼šç†Šç½ ã§ã‚‚æœ¬éƒ¨ã§ã‚‚ãªã„ã‚‚ã®ã§ã€ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã‚‚ã®
      if (!obj.label) return false;
      if (obj.label === "ç†Šç½ 1" || obj.label === "ç†Šç½ 2") return false;
      if (obj.label === "é›ªåŸæœ¬éƒ¨") return false;
      if (obj.label === "ğŸš©") return false; // æ——ã‚’é™¤å¤–
      if ((obj.type || "").toUpperCase() === "DEPOT") return false; // è³‡æºã‚‚é™¤å¤–
      if ((obj.type || "").toUpperCase() === "STATUE") return false; // åƒã‚‚é™¤å¤–
      return true;
    });

    // å„éƒ½å¸‚ã‹ã‚‰å…µå£«ã‚’å‡ºã™
    const newAnimations: SoldierAnimation[] = cities.map(city => {
      // è¤‡æ•°ã®å…µå£«ã‚’ç”Ÿæˆï¼ˆ8-15äººã®å…µå£«ï¼‰
      const soldierCount = 8 + Math.floor(Math.random() * 8);
      const soldiers = [];
      
      for (let i = 0; i < soldierCount; i++) {
        soldiers.push({
          offsetX: (Math.random() - 0.5) * 30, // ãƒ©ãƒ³ãƒ€ãƒ ãªæ¨ªãšã‚Œ
          offsetY: (Math.random() - 0.5) * 30, // ãƒ©ãƒ³ãƒ€ãƒ ãªç¸¦ãšã‚Œ
          delay: Math.random() * 0.2, // 0-0.2ã®å‡ºç™ºé…å»¶
        });
      }

      return {
        from: {
          x: num(city.x, 0),
          y: num(city.y, 0),
          label: city.label || "",
        },
        to: {
          x: num(bearTrap.x, 0),
          y: num(bearTrap.y, 0),
          label: bearTrap.label || "",
        },
        progress: 0,
        startTime: Date.now(),
        soldiers,
      };
    });

    setSoldierAnimations(newAnimations);
  };

  // å…µå£«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ—
  useEffect(() => {
    if (soldierAnimations.length === 0) return;

    const animate = () => {
      const now = Date.now();
      let allComplete = true;

      setSoldierAnimations(prev => {
        return prev.map(anim => {
          const elapsed = now - anim.startTime;
          const duration = 2500; // 2.5ç§’ã‹ã‘ã¦ç§»å‹•
          const progress = Math.min(elapsed / duration, 1);
          
          if (progress < 1) allComplete = false;
          
          return { ...anim, progress };
        });
      });

      if (!allComplete) {
        soldierAnimationRef.current = requestAnimationFrame(animate);
      } else {
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼šå°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¯ãƒªã‚¢
        setTimeout(() => {
          setSoldierAnimations([]);
        }, 500);
      }
      
      draw(); // å†æç”»
    };

    soldierAnimationRef.current = requestAnimationFrame(animate);

    return () => {
      if (soldierAnimationRef.current) {
        cancelAnimationFrame(soldierAnimationRef.current);
        soldierAnimationRef.current = null;
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [soldierAnimations.length > 0 ? soldierAnimations[0]?.startTime : 0]);

