// ===============================================
// ç†Šç½ ã‚¿ãƒƒãƒ—æ™‚ã®å…µå£«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ã‚¬ã‚¤ãƒ‰
// ===============================================

// ============ 1. Stateå®šç¾©ã®è¿½åŠ  ============
// 216è¡Œç›®ä»˜è¿‘ï¼ˆisMobileã¨isDarkModeã®å®šç¾©ã®å¾Œï¼‰ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

  // ç†Šç½ â†’å…µå£«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
  type SoldierAnimation = {
    from: { x: number; y: number; label: string }; // å‡ºç™ºåœ°ï¼ˆéƒ½å¸‚ï¼‰
    to: { x: number; y: number; label: string }; // ç›®çš„åœ°ï¼ˆç†Šç½ ï¼‰
    progress: number; // 0-1ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€²æ—
    startTime: number; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»
    soldiers: Array<{ // å…µå£«ç¾¤ï¼ˆè¤‡æ•°ã®å…µå£«ãŒè¡Œé€²ï¼‰
      offsetX: number; // éšŠåˆ—ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
      offsetY: number;
      delay: number; // å‡ºç™ºã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ãšã‚Œ
    }>;
  };
  const [soldierAnimations, setSoldierAnimations] = useState<SoldierAnimation[]>([]);
  const soldierAnimationRef = useRef<number | null>(null);


// ============ 2. onClické–¢æ•°ã®ä¿®æ­£ ============
// 1824è¡Œç›®ä»˜è¿‘ã® onClick é–¢æ•°å†…ã€hit = hitTest(mx, my) ã®ç›´å¾Œã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

    const hit = hitTest(mx, my);
    
    // å‚ç…§ãƒ¢ãƒ¼ãƒ‰æ™‚ã«ç†Šç½ ã‚’ã‚¿ãƒƒãƒ—ã—ãŸå ´åˆã€å…µå£«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    if (!isEditMode && hit && (hit.label === "ç†Šç½ 1" || hit.label === "ç†Šç½ 2")) {
      startSoldierAnimation(hit);
      setSelectedId(hit?.id ? String(hit.id) : null);
      return;
    }


// ============ 3. drawé–¢æ•°å†…ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æç”»ã‚’è¿½åŠ  ============
// 1369è¡Œç›®ä»˜è¿‘ã€drawé–¢æ•°ã®çµ‚ã‚ã‚Šï¼ˆ}; ã®ç›´å‰ï¼‰ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

    // å…µå£«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æç”»
    if (soldierAnimations.length > 0) {
      ctx.save();
      ctx.translate(viewW / 2, viewH / 2);
      ctx.translate(cam.tx, cam.ty);
      ctx.scale(cam.scale, cam.scale);
      ctx.rotate(LOOK.angle);
      ctx.translate(-cx, -cy);

      soldierAnimations.forEach((anim) => {
        const { from, to, progress, soldiers } = anim;
        const fromX = from.x * cell + (Math.max(1, 2) * cell) / 2; // éƒ½å¸‚ã®ä¸­å¿ƒ
        const fromY = from.y * cell + (Math.max(1, 2) * cell) / 2;
        const toX = to.x * cell + (Math.max(1, 3) * cell) / 2; // ç†Šç½ ã®ä¸­å¿ƒ
        const toY = to.y * cell + (Math.max(1, 3) * cell) / 2;

        soldiers.forEach((soldier) => {
          const soldierProgress = Math.max(0, Math.min(1, (progress - soldier.delay) / (1 - soldier.delay)));
          if (soldierProgress <= 0) return; // ã¾ã å‡ºç™ºã—ã¦ã„ãªã„

          const currentX = fromX + (toX - fromX) * soldierProgress + soldier.offsetX;
          const currentY = fromY + (toY - fromY) * soldierProgress + soldier.offsetY;

          // å…µå£«ã‚’æç”»ï¼ˆçµµæ–‡å­—ã¾ãŸã¯ã‚¢ã‚¤ã‚³ãƒ³ï¼‰
          ctx.save();
          ctx.translate(currentX, currentY);
          ctx.rotate(-LOOK.angle); // æ–‡å­—ã‚’æ°´å¹³ã«

          // å…µå£«ã®ã‚µã‚¤ã‚ºã¨è¦‹ãŸç›®
          const soldierSize = 16;
          ctx.font = `${soldierSize}px serif`;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          
          // è¤‡æ•°ç¨®é¡ã®å…µå£«çµµæ–‡å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ï¼ˆseedãƒ™ãƒ¼ã‚¹ï¼‰
          const soldierEmojis = ['ğŸƒ', 'ğŸƒâ€â™‚ï¸', 'ğŸƒâ€â™€ï¸', 'ğŸš¶', 'ğŸš¶â€â™‚ï¸', 'ğŸš¶â€â™€ï¸'];
          const seed = Math.floor(soldier.offsetX * 1000 + soldier.offsetY * 1000);
          const emoji = soldierEmojis[seed % soldierEmojis.length];
          
          // å½±ã‚’è¿½åŠ 
          ctx.shadowColor = "rgba(0,0,0,0.3)";
          ctx.shadowBlur = 4;
          ctx.shadowOffsetY = 2;
          ctx.fillText(emoji, 0, 0);
          
          ctx.restore();
        });
      });

      ctx.restore();
    }


// ============ 4. é–¢æ•°å®šç¾©ã®è¿½åŠ  ============
// drawé–¢æ•°ã®ç›´å¾Œï¼ˆ1371è¡Œç›®ä»˜è¿‘ï¼‰ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

  // å…µå£«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹é–¢æ•°
  const startSoldierAnimation = (bearTrap: Obj) => {
    // ã™ã¹ã¦ã®éƒ½å¸‚ã‚’æ¤œç´¢ï¼ˆè¿‘ãã«ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’éƒ½å¸‚ã¨ã¿ãªã™ï¼‰
    const cities = objects.filter(obj => {
      // éƒ½å¸‚åˆ¤å®šï¼šç†Šç½ ã§ã‚‚æœ¬éƒ¨ã§ã‚‚ãªã„ã‚‚ã®ã§ã€ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã‚‚ã®
      if (!obj.label) return false;
      if (obj.label === "ç†Šç½ 1" || obj.label === "ç†Šç½ 2") return false;
      if (obj.label === "é›ªåŸæœ¬éƒ¨") return false;
      if (obj.label === "ğŸš©") return false; // æ——ã‚’é™¤å¤–
      if ((obj.type || "").toUpperCase() === "DEPOT") return false; // è³‡æºã‚‚é™¤å¤–
      if ((obj.type || "").toUpperCase() === "STATUE") return false; // åƒã‚‚é™¤å¤–
      return true;
    });

    // å„éƒ½å¸‚ã‹ã‚‰å…µå£«ã‚’å‡ºã™
    const newAnimations: SoldierAnimation[] = cities.map(city => {
      // è¤‡æ•°ã®å…µå£«ã‚’ç”Ÿæˆï¼ˆ8-15äººã®å…µå£«ï¼‰
      const soldierCount = 8 + Math.floor(Math.random() * 8);
      const soldiers = [];
      
      for (let i = 0; i < soldierCount; i++) {
        soldiers.push({
          offsetX: (Math.random() - 0.5) * 30, // ãƒ©ãƒ³ãƒ€ãƒ ãªæ¨ªãšã‚Œ
          offsetY: (Math.random() - 0.5) * 30, // ãƒ©ãƒ³ãƒ€ãƒ ãªç¸¦ãšã‚Œ
          delay: Math.random() * 0.2, // 0-0.2ã®å‡ºç™ºé…å»¶
        });
      }

      return {
        from: {
          x: num(city.x, 0),
          y: num(city.y, 0),
          label: city.label || "",
        },
        to: {
          x: num(bearTrap.x, 0),
          y: num(bearTrap.y, 0),
          label: bearTrap.label || "",
        },
        progress: 0,
        startTime: Date.now(),
        soldiers,
      };
    });

    setSoldierAnimations(newAnimations);
  };

  // å…µå£«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ—
  useEffect(() => {
    if (soldierAnimations.length === 0) return;

    const animate = () => {
      const now = Date.now();
      let allComplete = true;

      setSoldierAnimations(prev => {
        return prev.map(anim => {
          const elapsed = now - anim.startTime;
          const duration = 2500; // 2.5ç§’ã‹ã‘ã¦ç§»å‹•
          const progress = Math.min(elapsed / duration, 1);
          
          if (progress < 1) allComplete = false;
          
          return { ...anim, progress };
        });
      });

      if (!allComplete) {
        soldierAnimationRef.current = requestAnimationFrame(animate);
      } else {
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼šå°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¯ãƒªã‚¢
        setTimeout(() => {
          setSoldierAnimations([]);
        }, 500);
      }
      
      draw(); // å†æç”»
    };

    soldierAnimationRef.current = requestAnimationFrame(animate);

    return () => {
      if (soldierAnimationRef.current) {
        cancelAnimationFrame(soldierAnimationRef.current);
        soldierAnimationRef.current = null;
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [soldierAnimations.length > 0 ? soldierAnimations[0]?.startTime : 0]);


// ============ å®Ÿè£…å®Œäº†ï¼ ============
// ä¸Šè¨˜ã®4ã¤ã®å¤‰æ›´ã‚’è¡Œã†ã¨ã€å‚ç…§ãƒ¢ãƒ¼ãƒ‰ï¼ˆé–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼‰ã§ç†Šç½ 1ã¾ãŸã¯ç†Šç½ 2ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€
// ãƒãƒƒãƒ—ä¸Šã®ã™ã¹ã¦ã®éƒ½å¸‚ã‹ã‚‰å…µå£«ãŒç†Šç½ ã«å‘ã‹ã£ã¦è¡Œé€²ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
//
// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç‰¹å¾´ï¼š
// - å„éƒ½å¸‚ã‹ã‚‰8-15äººã®å…µå£«ãŒå‡ºç™º
// - å…µå£«ã¯å°‘ã—ãšã¤å‡ºç™ºã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒãšã‚Œã‚‹ï¼ˆãƒªã‚¢ãƒ«ãªè¡Œé€²ï¼‰
// - éšŠåˆ—ãŒãƒãƒ©ã‘ã¦è¡Œé€²ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãªã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
// - 2.5ç§’ã‹ã‘ã¦ç›®çš„åœ°ã«åˆ°é”
// - ğŸƒã‚„ğŸš¶ãªã©ã®çµµæ–‡å­—ã§ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«åŒ–
// - å½±ä»˜ãã§ã‚ˆã‚Šãƒªã‚¢ãƒ«ã«
